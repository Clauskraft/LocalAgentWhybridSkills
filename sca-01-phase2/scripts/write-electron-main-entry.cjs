const fs = require("node:fs");
const path = require("node:path");

/**
 * Writes a CommonJS Electron entrypoint to build/ui/main.cjs.
 *
 * Why: Electron's ESM loader can choke when an ESM main process module imports the
 * special 'electron' module on some Windows setups. By keeping the entrypoint CJS
 * (require('electron')) and dynamically importing our ESM bootstrap (main.js),
 * we avoid ESM<->CJS translation for the 'electron' module itself.
 */

const outDir = path.join(process.cwd(), "build", "ui");
fs.mkdirSync(outDir, { recursive: true });

const outFile = path.join(outDir, "main.cjs");

const content = `// Auto-generated by scripts/write-electron-main-entry.cjs
const path = require("node:path");
const { pathToFileURL } = require("node:url");
const electron = require("electron");

(async () => {
  const bootstrapUrl = pathToFileURL(path.join(__dirname, "main.js")).href;
  const mod = await import(bootstrapUrl);
  if (!mod || typeof mod.startMain !== "function") {
    throw new Error("build/ui/main.js must export async function startMain(electron)");
  }
  await mod.startMain(electron);
})().catch((err) => {
  // eslint-disable-next-line no-console
  console.error(err);
  process.exit(1);
});
`;

fs.writeFileSync(outFile, content, "utf8");
// eslint-disable-next-line no-console
console.log(`âœ… Wrote Electron entrypoint: ${path.relative(process.cwd(), outFile)}`);


