name: Production Monitor

on:
  schedule:
    - cron: '*/30 * * * *'  # Every 30 minutes
  workflow_dispatch:

permissions:
  issues: write

jobs:
  health-check:
    name: Health Check
    runs-on: ubuntu-latest
    
    steps:
      - name: Check WidgeTDC Backend
        id: widgetdc
        continue-on-error: true
        run: |
          RESPONSE=$(curl -s -o /dev/null -w "%{http_code}" https://backend-production-d3da.up.railway.app/health || echo "000")
          echo "status=$RESPONSE" >> $GITHUB_OUTPUT
          if [ "$RESPONSE" = "200" ]; then
            echo "âœ… WidgeTDC Backend: Healthy"
          else
            echo "âŒ WidgeTDC Backend: Unhealthy (HTTP $RESPONSE)"
          fi

      - name: Report Status
        run: |
          echo "## ðŸ¥ Health Check Report"
          echo "- WidgeTDC Backend: ${{ steps.widgetdc.outputs.status }}"
          echo "- Timestamp: $(date -u)"

      - name: Create Issue on Failure
        if: steps.widgetdc.outputs.status != '200'
        uses: actions/github-script@v8
        with:
          script: |
            const title = `ðŸš¨ Production Health Check Failed - ${new Date().toISOString().split('T')[0]}`;
            const body = `
            ## Health Check Failure

            **Time:** ${new Date().toISOString()}
            **WidgeTDC Backend:** HTTP ${{ steps.widgetdc.outputs.status }}

            ### Action Required
            1. Check Railway logs
            2. Verify database connectivity
            3. Check for recent deployments

            ---
            *This issue was created automatically by the production monitor.*
            `;
            
            // Check for existing open issue
            const issues = await github.rest.issues.listForRepo({
              owner: context.repo.owner,
              repo: context.repo.repo,
              state: 'open',
              labels: 'production-alert'
            });
            
            const existingIssue = issues.data.find(i => i.title.includes('Production Health Check Failed'));
            
            if (!existingIssue) {
              await github.rest.issues.create({
                owner: context.repo.owner,
                repo: context.repo.repo,
                title: title,
                body: body,
                labels: ['production-alert', 'urgent']
              });
            }
